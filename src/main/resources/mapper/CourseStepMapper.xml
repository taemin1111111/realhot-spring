<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wherehot.spring.mapper.CourseStepMapper">

    <!-- 결과 매핑 -->
    <resultMap id="CourseStepResultMap" type="com.wherehot.spring.entity.CourseStep">
        <id property="id" column="id"/>
        <result property="courseId" column="course_id"/>
        <result property="stepNo" column="step_no"/>
        <result property="placeId" column="place_id"/>
        <result property="placeName" column="placeName"/>
        <result property="placeAddress" column="placeAddress"/>
        <result property="photoUrl" column="photo_url"/>
        <result property="description" column="description"/>
        <result property="createdAt" column="created_at"/>
    </resultMap>

    <!-- 코스의 모든 스텝 조회 -->
    <select id="getCourseStepsByCourseId" resultMap="CourseStepResultMap">
        SELECT cs.id, cs.course_id, cs.step_no, cs.place_id, cs.photo_url, cs.description, cs.created_at,
               h.name as placeName, h.address as placeAddress
        FROM course_step cs
        LEFT JOIN hotplace_info h ON cs.place_id = h.id
        WHERE cs.course_id = #{courseId}
        ORDER BY cs.step_no ASC
    </select>

    <!-- 코스 스텝 등록 -->
    <insert id="insertCourseStep" parameterType="com.wherehot.spring.entity.CourseStep" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO course_step (course_id, step_no, place_id, photo_url, description, created_at)
        VALUES (#{courseId}, #{stepNo}, #{placeId}, #{photoUrl}, #{description}, NOW())
    </insert>

    <!-- 코스 스텝 수정 -->
    <update id="updateCourseStep" parameterType="com.wherehot.spring.entity.CourseStep">
        UPDATE course_step 
        SET step_no = #{stepNo}, place_id = #{placeId}, photo_url = #{photoUrl}, description = #{description}
        WHERE id = #{id}
    </update>

    <!-- 코스 스텝 삭제 -->
    <delete id="deleteCourseStep">
        DELETE FROM course_step WHERE id = #{id}
    </delete>

    <!-- 코스의 모든 스텝 삭제 -->
    <delete id="deleteAllCourseStepsByCourseId">
        DELETE FROM course_step WHERE course_id = #{courseId}
    </delete>

    <!-- 특정 스텝 번호의 스텝 조회 -->
    <select id="getCourseStepByCourseIdAndStepNo" resultMap="CourseStepResultMap">
        SELECT id, course_id, step_no, place_id, photo_url, description, created_at
        FROM course_step 
        WHERE course_id = #{courseId} AND step_no = #{stepNo}
    </select>

    <!-- 코스의 스텝 개수 조회 -->
    <select id="getCourseStepCount" resultType="int">
        SELECT COUNT(*) FROM course_step WHERE course_id = #{courseId}
    </select>

    <!-- 특정 가게가 포함된 코스 개수 조회 -->
    <select id="getCourseCountByPlaceId" resultType="int">
        SELECT COUNT(DISTINCT course_id) FROM course_step WHERE place_id = #{placeId}
    </select>

</mapper>
