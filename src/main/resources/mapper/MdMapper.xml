<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wherehot.spring.mapper.MdMapper">

    <!-- MD 목록 조회 (페이징, 검색, 정렬) -->
    <select id="selectMdList" resultType="com.wherehot.spring.entity.Md">
        SELECT 
            m.md_id as mdId,
            m.place_id as placeId,
            m.md_name as mdName,
            m.contact,
            m.description,
            m.photo,
            m.created_at as createdAt,
            m.is_visible as isVisible,
            COALESCE(w.wish_count, 0) as wishCount,
            CASE WHEN uw.md_id IS NOT NULL THEN true ELSE false END as wished,
            p.name as placeName,
            p.address as placeAddress
        FROM md_info m
        LEFT JOIN hotplace_info p ON m.place_id = p.id
        LEFT JOIN (
            SELECT md_id, COUNT(*) as wish_count 
            FROM md_wish 
            GROUP BY md_id
        ) w ON m.md_id = w.md_id
        LEFT JOIN (
            SELECT md_id FROM md_wish WHERE userid = #{userId}
        ) uw ON m.md_id = uw.md_id
        WHERE m.is_visible = true
        <if test="keyword != null and keyword != ''">
            <choose>
                <when test="searchType == 'mdName'">
                    AND md_name LIKE CONCAT('%', #{keyword}, '%')
                </when>
                <when test="searchType == 'placeName'">
                    AND place_id IN (
                        SELECT id FROM hotplace_info 
                        WHERE name LIKE CONCAT('%', #{keyword}, '%')
                    )
                </when>
                <otherwise>
                    AND (md_name LIKE CONCAT('%', #{keyword}, '%') 
                         OR description LIKE CONCAT('%', #{keyword}, '%'))
                </otherwise>
            </choose>
        </if>
        <choose>
            <when test="sort == 'popular'">
                ORDER BY (
                    SELECT COUNT(*) FROM md_wish WHERE md_id = m.md_id
                ) DESC, m.created_at DESC
            </when>
            <otherwise>
                ORDER BY m.created_at DESC
            </otherwise>
        </choose>
        LIMIT #{size} OFFSET #{offset}
    </select>

    <!-- 전체 MD 개수 조회 -->
    <select id="selectMdCount" resultType="int">
        SELECT COUNT(*)
        FROM md_info
        WHERE is_visible = true
        <if test="keyword != null and keyword != ''">
            <choose>
                <when test="searchType == 'mdName'">
                    AND md_name LIKE CONCAT('%', #{keyword}, '%')
                </when>
                <when test="searchType == 'placeName'">
                    AND place_id IN (
                        SELECT id FROM hotplace_info 
                        WHERE name LIKE CONCAT('%', #{keyword}, '%')
                    )
                </when>
                <otherwise>
                    AND (md_name LIKE CONCAT('%', #{keyword}, '%') 
                         OR description LIKE CONCAT('%', #{keyword}, '%'))
                </otherwise>
            </choose>
        </if>
    </select>

    <!-- 디버깅용: 모든 MD 조회 -->
    <select id="selectAllMds" resultType="com.wherehot.spring.entity.Md">
        SELECT 
            m.md_id as mdId,
            m.place_id as placeId,
            m.md_name as mdName,
            m.contact,
            m.description,
            m.photo,
            m.created_at as createdAt,
            m.is_visible as isVisible,
            COALESCE(w.wish_count, 0) as wishCount,
            CASE WHEN uw.md_id IS NOT NULL THEN true ELSE false END as wished,
            p.name as placeName,
            p.address as placeAddress
        FROM md_info m
        LEFT JOIN hotplace_info p ON m.place_id = p.id
        LEFT JOIN (
            SELECT md_id, COUNT(*) as wish_count 
            FROM md_wish 
            GROUP BY md_id
        ) w ON m.md_id = w.md_id
        LEFT JOIN (
            SELECT md_id FROM md_wish WHERE userid = #{userId}
        ) uw ON m.md_id = uw.md_id
        WHERE m.is_visible = true
        ORDER BY m.created_at DESC
    </select>

    <!-- MD 상세 조회 -->
    <select id="selectMdById" resultType="com.wherehot.spring.entity.Md">
        SELECT 
            m.md_id as mdId,
            m.place_id as placeId,
            m.md_name as mdName,
            m.contact,
            m.description,
            m.photo,
            m.created_at as createdAt,
            m.is_visible as isVisible,
            p.name as placeName,
            p.address as placeAddress
        FROM md_info m
        LEFT JOIN hotplace_info p ON m.place_id = p.id
        WHERE m.md_id = #{mdId}
    </select>

    <!-- MD 등록 -->
    <insert id="insertMd" parameterType="com.wherehot.spring.entity.Md" useGeneratedKeys="true" keyProperty="mdId">
        INSERT INTO md_info (
            place_id,
            md_name,
            contact,
            description,
            photo,
            created_at,
            is_visible
        ) VALUES (
            #{placeId},
            #{mdName},
            #{contact},
            #{description},
            #{photo},
            NOW(),
            true
        )
    </insert>

    <!-- MD 수정 -->
    <update id="updateMd" parameterType="com.wherehot.spring.entity.Md">
        UPDATE md_info SET
            place_id = #{placeId},
            md_name = #{mdName},
            contact = #{contact},
            description = #{description},
            <if test="photo != null">
            photo = #{photo},
            </if>
            is_visible = #{isVisible}
        WHERE md_id = #{mdId}
    </update>

                           <!-- MD 찜하기 추가 -->
            <insert id="insertMdWish">
                INSERT INTO md_wish (md_id, userid, created_at)
                VALUES (#{mdId}, #{userId}, NOW())
            </insert>

           <!-- MD 찜하기 삭제 -->
           <delete id="deleteMdWish">
               DELETE FROM md_wish 
               WHERE md_id = #{mdId} AND userid = #{userId}
           </delete>

           <!-- MD 찜하기 여부 확인 -->
           <select id="selectMdWishCount" resultType="int">
               SELECT COUNT(*)
               FROM md_wish
               WHERE md_id = #{mdId} AND userid = #{userId}
           </select>

           <!-- MD 찜 개수 조회 -->
           <select id="selectMdWishTotalCount" resultType="int">
               SELECT COUNT(*)
               FROM md_wish
               WHERE md_id = #{mdId}
           </select>

           <!-- 가게 목록 조회 (MD 추가용) -->
           <select id="selectHotplaceList" resultType="map">
               SELECT 
                   id as placeId,
                   name as placeName,
                   address as placeAddress
               FROM hotplace_info
               ORDER BY name ASC
           </select>

           <!-- 가게 검색 (MD 추가용) -->
           <select id="searchHotplaces" resultType="map">
               SELECT 
                   id as placeId,
                   name as placeName,
                   address as placeAddress
               FROM hotplace_info
               WHERE name LIKE CONCAT('%', #{keyword}, '%')
               ORDER BY name ASC
               LIMIT 10
           </select>

    <!-- MD 찜 목록 삭제 -->
    <delete id="deleteMdWishes" parameterType="int">
        DELETE FROM md_wish WHERE md_id = #{mdId}
    </delete>

    <!-- MD 삭제 -->
    <delete id="deleteMd" parameterType="int">
        DELETE FROM md_info WHERE md_id = #{mdId}
    </delete>

    <!-- MD명 검색 (자동완성용) -->
    <select id="searchMdNames" resultType="map">
        SELECT DISTINCT
            m.md_name as mdName,
            p.name as placeName
        FROM md_info m
        LEFT JOIN hotplace_info p ON m.place_id = p.id
        WHERE m.is_visible = true
        AND m.md_name LIKE CONCAT('%', #{keyword}, '%')
        ORDER BY m.md_name ASC
        LIMIT 5
    </select>

</mapper>