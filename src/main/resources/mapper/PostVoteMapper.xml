<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wherehot.spring.mapper.PostVoteMapper">

    <!-- 결과 매핑 -->
    <resultMap id="PostVoteResultMap" type="com.wherehot.spring.entity.PostVote">
        <id property="id" column="id"/>
        <result property="postId" column="post_id"/>
        <result property="userKey" column="user_key"/>
        <result property="voteType" column="vote_type"/>
        <result property="createdAt" column="created_at"/>
    </resultMap>

    <!-- 투표 존재 여부 확인 -->
    <select id="existsVote" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM hottalk_vote 
        WHERE post_id = #{postId} AND user_key = #{userKey}
    </select>

    <!-- 투표 추가 -->
    <insert id="insertVote" parameterType="com.wherehot.spring.entity.PostVote" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO hottalk_vote (
            post_id, user_key, vote_type, created_at
        ) VALUES (
            #{postId}, #{userKey}, #{voteType}, NOW()
        )
    </insert>

    <!-- 투표 삭제 -->
    <delete id="deleteVote">
        DELETE FROM hottalk_vote 
        WHERE post_id = #{postId} AND user_key = #{userKey}
    </delete>

    <!-- 게시글별 투표 조회 -->
    <select id="getVotesByPostId" resultMap="PostVoteResultMap">
        SELECT id, post_id, user_key, vote_type, created_at
        FROM hottalk_vote 
        WHERE post_id = #{postId}
        ORDER BY created_at DESC
    </select>

    <!-- 사용자별 투표 조회 -->
    <select id="getVotesByUserKey" resultMap="PostVoteResultMap">
        SELECT id, post_id, user_key, vote_type, created_at
        FROM hottalk_vote 
        WHERE user_key = #{userKey}
        ORDER BY created_at DESC
    </select>

</mapper>
